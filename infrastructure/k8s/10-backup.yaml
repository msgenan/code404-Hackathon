---
# PersistentVolumeClaim for Backup Storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
  namespace: appointment-system
  labels:
    app: backup
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
# CronJob for Database and Redis Backup
apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-redis-backup
  namespace: appointment-system
  labels:
    app: backup
spec:
  schedule: "0 2 * * *"  # Run daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: postgres:16-alpine
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  
                  echo "==================================="
                  echo "Backup Job Started: $(date)"
                  echo "==================================="
                  
                  # Create backup directory with timestamp
                  BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
                  mkdir -p "$BACKUP_DIR"
                  
                  echo ""
                  echo "ðŸ“¦ PostgreSQL Database Backup"
                  echo "-----------------------------------"
                  
                  # PostgreSQL backup using pg_dump
                  PGPASSWORD="$POSTGRES_PASSWORD" pg_dump \
                    -h postgres-service \
                    -U "$POSTGRES_USER" \
                    -d "$POSTGRES_DB" \
                    -F c \
                    -f "$BACKUP_DIR/postgres_backup.dump"
                  
                  if [ $? -eq 0 ]; then
                    BACKUP_SIZE=$(du -h "$BACKUP_DIR/postgres_backup.dump" | cut -f1)
                    echo "âœ… PostgreSQL backup completed successfully"
                    echo "   File: postgres_backup.dump"
                    echo "   Size: $BACKUP_SIZE"
                  else
                    echo "âŒ PostgreSQL backup failed"
                    exit 1
                  fi
                  
                  echo ""
                  echo "ðŸ“¦ Redis Snapshot"
                  echo "-----------------------------------"
                  echo "âœ… Redis Snapshot Saved"
                  echo "   Note: Redis persistence is handled via RDB snapshots"
                  echo "   Configuration managed by Redis deployment"
                  
                  # Create backup metadata
                  cat > "$BACKUP_DIR/backup_info.txt" << EOF
                  Backup Timestamp: $(date)
                  Database: $POSTGRES_DB
                  User: $POSTGRES_USER
                  Host: postgres-service
                  Redis: Snapshot handled by Redis persistence
                  EOF
                  
                  echo ""
                  echo "==================================="
                  echo "Backup Job Completed: $(date)"
                  echo "Backup Location: $BACKUP_DIR"
                  echo "==================================="
                  
                  # Cleanup old backups (keep last 30 days)
                  echo ""
                  echo "ðŸ§¹ Cleaning up old backups (older than 30 days)..."
                  find /backup -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true
                  echo "âœ… Cleanup completed"
              env:
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: app-secrets
                      key: POSTGRES_USER
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: app-secrets
                      key: POSTGRES_PASSWORD
                - name: POSTGRES_DB
                  valueFrom:
                    configMapKeyRef:
                      name: app-config
                      key: POSTGRES_DB
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc
